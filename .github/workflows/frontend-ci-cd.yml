name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/frontend/**"
      - ".github/workflows/frontend-ci-cd.yml"
  workflow_dispatch: {}

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  frontend-ci:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      # [중요] 여기서 package.json에 cp 명령어가 잘 수정되어 있어야 합니다!
      - name: Build frontend (production)
        run: npm run build:production
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SOCKET_URL: ${{ secrets.NEXT_PUBLIC_SOCKET_URL }}

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          # apps/frontend 경로를 포함해서 압축합니다.
          path: |
            apps/frontend/.next/standalone
            apps/frontend/.next/static
            apps/frontend/public
            apps/frontend/restart.sh

  frontend-deploy:
    name: Frontend Deploy to EC2
    runs-on: ubuntu-latest
    needs: frontend-ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # [수정됨] path를 apps/frontend가 아니라 .(현재위치)로 변경
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: .
          # 이렇게 해야 apps/frontend 폴더 위에 덮어씌워지면서
          # apps/frontend/.next/standalone 경로가 정상적으로 생성됩니다.

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get frontend instance IPs by tags
        id: get_frontend_ips
        run: |
          IPS=$(aws ec2 describe-instances \
            --filters \
              "Name=tag:Service,Values=frontend" \
              "Name=tag:Env,Values=prod" \
              "Name=tag:AutoDeploy,Values=true" \
              "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)

          if [ -z "$IPS" ]; then
            echo "No frontend instances found"
            exit 1
          fi
          echo "ips=$IPS" >> $GITHUB_OUTPUT

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add frontend hosts to known_hosts
        run: |
          mkdir -p ~/.ssh
          for ip in ${{ steps.get_frontend_ips.outputs.ips }}; do
            ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      # [디버깅] 실제 구조 확인 (이제 정상적으로 보일 것입니다)
      - name: Debug - List standalone files
        working-directory: apps/frontend
        run: |
          echo "Checking structure..."
          ls -R .next/standalone || echo "❌ Standalone folder not found!"
          
          echo "Checking manifests (Crucial for Start)..."
          ls -l .next/standalone/.next/routes-manifest.json || echo "❌ routes-manifest.json MISSING (Fix package.json!)"

      - name: Deploy frontend via Makefile
        working-directory: apps/frontend
        env:
          DEPLOY_SERVERS: ${{ steps.get_frontend_ips.outputs.ips }}
          DEPLOY_PATH: /home/ubuntu/ktb-chat-frontend
        run: make deploy