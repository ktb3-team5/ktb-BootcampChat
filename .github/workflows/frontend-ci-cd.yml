name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/frontend/**"
      - ".github/workflows/frontend-ci-cd.yml"
  workflow_dispatch: {}

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  frontend-ci:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend (production)
        run: npm run build:production
        env:
          # 빌드 타임에 환경변수 주입 (중요)
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SOCKET_URL: ${{ secrets.NEXT_PUBLIC_SOCKET_URL }}

      - name: Debug .next contents
        run: |
          echo "PWD: $(pwd)"
          ls -R .
          echo "---- .next ----"
          ls -R .next || echo ".next not found"

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            apps/frontend/.next/standalone
            apps/frontend/.next/static
            apps/frontend/public
            apps/frontend/restart.sh

  frontend-deploy:
    name: Frontend Deploy to EC2
    runs-on: ubuntu-latest
    needs: frontend-ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: apps/frontend

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get frontend instance IPs by tags
        id: get_frontend_ips
        run: |
          # PublicIpAddress를 가져오도록 설정됨
          IPS=$(aws ec2 describe-instances \
            --filters \
              "Name=tag:Service,Values=frontend" \
              "Name=tag:Env,Values=prod" \
              "Name=tag:AutoDeploy,Values=true" \
              "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)

          echo "Frontend IPs: $IPS"
          if [ -z "$IPS" ]; then
            echo "No frontend instances found with given tags"
            exit 1
          fi

          echo "ips=$IPS" >> $GITHUB_OUTPUT

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add frontend hosts to known_hosts
        run: |
          mkdir -p ~/.ssh
          for ip in ${{ steps.get_frontend_ips.outputs.ips }}; do
            ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      - name: Debug - List standalone files
        working-directory: apps/frontend
        run: |
          echo "Checking standalone directory structure..."
          ls -R .next/standalone
          echo "Checking if BUILD_ID exists..."
          ls -l .next/standalone/.next/BUILD_ID || echo "BUILD_ID is MISSING!"

      - name: Deploy frontend via Makefile
        working-directory: apps/frontend
        env:
          DEPLOY_SERVERS: ${{ steps.get_frontend_ips.outputs.ips }}
          DEPLOY_PATH: /home/ubuntu/ktb-chat-frontend
        run: |
          echo "Deploying frontend to: $DEPLOY_SERVERS"
          make deploy