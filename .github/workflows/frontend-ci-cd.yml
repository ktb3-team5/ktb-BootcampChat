name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/frontend/**"
      - ".github/workflows/frontend-ci-cd.yml"
  workflow_dispatch: {}

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  frontend-ci:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend (production)
        run: npm run build:production
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SOCKET_URL: ${{ secrets.NEXT_PUBLIC_SOCKET_URL }}

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            apps/frontend/.next/standalone
            apps/frontend/.next/static
            apps/frontend/public
            apps/frontend/restart.sh

  frontend-deploy:
    name: Frontend Deploy to EC2
    runs-on: ubuntu-latest
    needs: frontend-ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: apps/frontend

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get frontend instance IPs by tags
        id: get_frontend_ips
        run: |
          IPS=$(aws ec2 describe-instances \
            --filters \
              "Name=tag:Service,Values=frontend" \
              "Name=tag:Env,Values=prod" \
              "Name=tag:AutoDeploy,Values=true" \
              "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)

          echo "Frontend IPs: $IPS"
          if [ -z "$IPS" ]; then
            echo "No frontend instances found with given tags"
            exit 1
          fi

          echo "ips=$IPS" >> $GITHUB_OUTPUT

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add frontend hosts to known_hosts
        run: |
          mkdir -p ~/.ssh
          for ip in ${{ steps.get_frontend_ips.outputs.ips }}; do
            ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      - name: Deploy frontend via Makefile
        working-directory: apps/frontend
        env:
          DEPLOY_SERVERS: ${{ steps.get_frontend_ips.outputs.ips }}
          DEPLOY_PATH: /home/ubuntu/ktb-chat-frontend
        run: |
          echo "Deploying frontend to: $DEPLOY_SERVERS"
          make deploy

#      - name: Frontend health check
#        if: steps.get_frontend_ips.outputs.ips != ''
#        run: |
#          # IP ëª©ë¡ì„ ê³µë°± ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë°°ì—´ë¡œ ìˆœíšŒ
#          for IP in ${{ steps.get_frontend_ips.outputs.ips }}; do
#            echo "=================================================="
#            echo "Checking Frontend Server: $IP"
#            echo "=================================================="
#
#            HEALTHCHECK_URL="http://$IP:3000/"
#
#            # ê° ì„œë²„ë³„ë¡œ ìµœëŒ€ 10ë²ˆ ì‹œë„
#            ATTEMPT=0
#            MAX_ATTEMPTS=10
#            SUCCESS=false
#
#            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
#              ATTEMPT=$((ATTEMPT+1))
#
#              # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸ (íƒ€ì„ì•„ì›ƒ 2ì´ˆ)
#              STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "$HEALTHCHECK_URL" || echo "000")
#
#              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Status $STATUS"
#
#              if [ "$STATUS" = "200" ]; then
#                echo "âœ… Server $IP is healthy!"
#                SUCCESS=true
#                break
#              fi
#
#              sleep 5
#            done
#
#            if [ "$SUCCESS" = false ]; then
#              echo "âŒ Server $IP failed health check!"
#              exit 1
#            fi
#          done
#
#          echo "ğŸ‰ All frontend servers are healthy!"